<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8">
<title>üÉè L·∫≠t Th·∫ª Var - TMA Party 3D üéâ</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
html,body{
  margin:0;height:100%;
  background:linear-gradient(135deg,#667eea 0%,#764ba2 50%,#f093fb 100%);
  background-size:200% 200%;
  animation:bgShift 15s ease infinite;
  font-family:'Comic Sans MS',cursive,system-ui,Arial;
  color:#0b1020;
  overflow:hidden;
}
@keyframes bgShift{
  0%, 100%{background-position:0% 50%;}
  50%{background-position:100% 50%;}
}

#ui{
  position:fixed;top:12px;left:12px;width:380px;
  background:linear-gradient(145deg,rgba(255,255,255,0.96),rgba(248,249,255,0.96));
  border-radius:20px;padding:20px;
  box-shadow:0 20px 60px rgba(102,126,234,0.6), 0 0 40px rgba(255,165,0,0.3);
  z-index:10;
  border:3px solid #ffa500;
  backdrop-filter:blur(15px);
  animation:panelFloat 3s ease-in-out infinite;
}
@keyframes panelFloat{
  0%, 100%{transform:translateY(0px);}
  50%{transform:translateY(-5px);}
}

.form-group{
  margin-bottom:14px;
}
.form-group label{
  display:block;
  font-weight:700;
  margin-bottom:6px;
  color:#764ba2;
  font-size:15px;
  text-shadow:0 0 10px rgba(118,75,162,0.2);
}
textarea,input{
  width:100%;padding:10px;
  border-radius:12px;border:2px solid #667eea;
  font-family:inherit;
  transition:all 0.3s;
  background:rgba(255,255,255,0.9);
}
textarea:focus,input:focus{
  outline:none;
  border-color:#ffd700;
  box-shadow:0 0 0 3px rgba(255,215,0,0.3), 0 0 20px rgba(255,215,0,0.2);
  transform:translateY(-2px);
}
button{
  width:100%;padding:14px;border-radius:12px;
  border:none;font-weight:700;cursor:pointer;
  background:linear-gradient(135deg,#ffa500 0%,#ffb84d 50%,#ffa500 100%);
  background-size:200% 100%;
  color:#764ba2;
  font-size:16px;
  transition:all 0.3s;
  box-shadow:0 5px 15px rgba(255,165,0,0.4);
  animation:gradientSlide 3s ease infinite;
  position:relative;
  overflow:hidden;
}
button::before{
  content:'';position:absolute;top:50%;left:50%;
  width:0;height:0;background:rgba(255,255,255,0.3);
  border-radius:50%;transform:translate(-50%,-50%);
  transition:width 0.6s, height 0.6s;
}
button:hover::before{
  width:300%;height:300%;
}
button:hover{
  transform:translateY(-3px) scale(1.02);
  box-shadow:0 10px 30px rgba(255,165,0,0.7), 0 0 20px rgba(255,165,0,0.4);
}
@keyframes gradientSlide{
  0%, 100%{background-position:0% 50%;}
  50%{background-position:100% 50%;}
}

#hud{
  position:fixed;right:12px;top:12px;width:340px;
  background:linear-gradient(145deg,rgba(255,255,255,0.96),rgba(248,249,255,0.96));
  border-radius:20px;padding:16px;
  box-shadow:0 20px 60px rgba(102,126,234,0.5), 0 0 30px rgba(102,126,234,0.3);
  z-index:10;
  border:3px solid #667eea;
  backdrop-filter:blur(15px);
  animation:infoPulse 2s ease-in-out infinite;
}
@keyframes infoPulse{
  0%, 100%{box-shadow:0 20px 60px rgba(102,126,234,0.5), 0 0 30px rgba(102,126,234,0.3);}
  50%{box-shadow:0 20px 60px rgba(102,126,234,0.5), 0 0 50px rgba(102,126,234,0.6), 0 0 80px rgba(102,126,234,0.2);}
}
#status{
  font-size:15px;
  font-weight:600;
  margin-bottom:10px;
  color:#764ba2;
}
#caughtList{
  font-size:13px;
  line-height:1.7;
  max-height:250px;
  overflow-y:auto;
  padding:10px;
  background:rgba(102,126,234,0.08);
  border-radius:10px;
}
.drunk-item{
  padding:8px 0;
  border-bottom:2px solid rgba(255,165,0,0.3);
  animation:slideIn 0.5s ease-out;
}
.drunk-item:last-child{
  border-bottom:none;
}
@keyframes slideIn{
  from{opacity:0;transform:translateX(20px);}
  to{opacity:1;transform:translateX(0);}
}

#instruction{
  position:fixed;bottom:20px;left:50%;transform:translateX(-50%);
  background:linear-gradient(145deg,rgba(255,255,255,0.95),rgba(240,248,255,0.95));
  padding:15px 30px;border-radius:15px;
  box-shadow:0 10px 30px rgba(0,0,0,0.3), 0 0 20px rgba(102,126,234,0.3);
  font-weight:700;color:#667eea;font-size:16px;
  border:2px solid rgba(255,255,255,0.8);
  backdrop-filter:blur(15px);
  display:none;
  z-index:9;
  text-align:center;
  animation:instructionPulse 2s ease-in-out infinite;
}
@keyframes instructionPulse{
  0%, 100%{transform:translateX(-50%) scale(1);}
  50%{transform:translateX(-50%) scale(1.05);}
}

/* Popup overlay */
#popupOverlay{
  position:fixed;
  top:0;left:0;right:0;bottom:0;
  background:rgba(102,126,234,0.9);
  display:none;
  z-index:100;
  align-items:center;
  justify-content:center;
  backdrop-filter:blur(10px);
}
#popup{
  background:linear-gradient(145deg,#ffffff,#f8f9ff);
  border-radius:24px;
  padding:32px;
  max-width:550px;
  width:92%;
  box-shadow:0 30px 100px rgba(0,0,0,0.5), 0 0 60px rgba(255,165,0,0.5);
  border:4px solid #ffa500;
  animation:popIn 0.4s cubic-bezier(0.68,-0.55,0.265,1.55);
  box-sizing:border-box;
  overflow:hidden;
}
@keyframes popIn{
  from{transform:scale(0.5) rotate(-5deg);opacity:0;}
  to{transform:scale(1) rotate(0deg);opacity:1;}
}
#popup.large{
  max-width:750px;
  max-height:88vh;
  overflow-y:auto;
}
#popup h2{
  margin:0 0 18px 0;
  color:#764ba2;
  font-size:28px;
  text-align:center;
  word-wrap:break-word;
  overflow-wrap:break-word;
  text-shadow:0 0 20px rgba(118,75,162,0.3);
}
.party-title{
  color:#ffa500;
  font-size:36px;
  font-weight:900;
  margin:10px 0;
  text-shadow:2px 2px 0 #764ba2, 0 0 20px rgba(255,165,0,0.5);
  text-align:center;
  box-sizing:border-box;
  animation:titleGlow 2s ease-in-out infinite;
}
@keyframes titleGlow{
  0%, 100%{text-shadow:2px 2px 0 #764ba2, 0 0 20px rgba(255,165,0,0.5);}
  50%{text-shadow:2px 2px 0 #764ba2, 0 0 30px rgba(255,165,0,0.8), 0 0 50px rgba(255,165,0,0.3);}
}
.status-badge{
  display:inline-block;
  padding:10px 20px;
  border-radius:12px;
  font-weight:700;
  font-size:18px;
  margin:15px 0;
  text-align:center;
  width:100%;
  animation:bounce 0.6s ease-in-out;
  box-sizing:border-box;
}
@keyframes bounce{
  0%,100%{transform:scale(1);}
  50%{transform:scale(1.08);}
}
.status-ok{
  background:linear-gradient(135deg,#00d2ff,#3a7bd5);
  color:white;
  box-shadow:0 5px 20px rgba(0,210,255,0.5);
}
.status-drunk{
  background:linear-gradient(135deg,#ff6b6b,#ee5a6f);
  color:white;
  box-shadow:0 5px 20px rgba(255,107,107,0.5);
}
.drunk-detail{
  background:linear-gradient(135deg,#ffe66d,#ffed4e);
  border-left:5px solid #ffa500;
  padding:16px;
  border-radius:10px;
  margin:15px 0;
  font-size:15px;
  color:#764ba2;
  font-weight:600;
  text-align:center;
  word-wrap:break-word;
  overflow-wrap:break-word;
  max-width:100%;
  box-sizing:border-box;
  box-shadow:0 5px 15px rgba(255,230,109,0.3);
}
.gift-box{
  font-size:60px;
  text-align:center;
  margin:15px 0;
  animation:shake 0.8s infinite, giftGlow 2s ease-in-out infinite;
}
@keyframes shake{
  0%,100%{transform:rotate(0deg) scale(1);}
  25%{transform:rotate(-5deg) scale(1.05);}
  75%{transform:rotate(5deg) scale(1.05);}
}
@keyframes giftGlow{
  0%, 100%{filter:drop-shadow(0 0 10px rgba(255,165,0,0.5));}
  50%{filter:drop-shadow(0 0 20px rgba(255,215,0,0.8));}
}
#popupButton{
  width:100%;
  margin-top:20px;
  padding:14px;
  background:linear-gradient(135deg,#667eea,#764ba2);
  color:white;
  border:none;
  border-radius:12px;
  font-weight:700;
  font-size:17px;
  cursor:pointer;
  transition:all 0.3s;
  box-shadow:0 5px 15px rgba(102,126,234,0.4);
}
#popupButton:hover{
  transform:translateY(-2px);
  box-shadow:0 8px 20px rgba(102,126,234,0.6);
}

/* Final report popup */
#finalReport{
  max-height:420px;
  overflow-y:auto;
  margin-bottom:18px;
}
.report-item{
  padding:16px 20px;
  background:linear-gradient(135deg,#fff,#f8f9ff);
  border-radius:12px;
  margin-bottom:15px;
  border-left:5px solid #ffa500;
  font-size:16px;
  box-shadow:0 5px 15px rgba(0,0,0,0.15);
  transition:all 0.3s;
}
.report-item:hover{
  transform:translateX(5px);
  box-shadow:0 8px 25px rgba(102,126,234,0.3);
}
.report-item strong{
  font-size:18px;
  color:#764ba2;
}
.report-item .drunk-text{
  color:#ff6b6b;
  margin-top:6px;
  display:block;
  font-weight:600;
}
.report-item .gift-text{
  color:#ffa500;
  margin-top:6px;
  display:block;
  font-weight:600;
  font-style:italic;
}
#copyButton{
  width:100%;
  margin-bottom:10px;
  padding:14px;
  background:linear-gradient(135deg,#00d2ff,#3a7bd5);
  color:white;
  border:none;
  border-radius:12px;
  font-weight:700;
  font-size:17px;
  cursor:pointer;
  transition:all 0.3s;
  box-shadow:0 5px 15px rgba(0,210,255,0.4);
}
#copyButton:hover{
  transform:translateY(-2px);
  box-shadow:0 8px 20px rgba(0,210,255,0.6);
}
#resetButton{
  width:100%;
  padding:14px;
  background:linear-gradient(135deg,#667eea,#764ba2);
  color:white;
  border:none;
  border-radius:12px;
  font-weight:700;
  font-size:17px;
  cursor:pointer;
  transition:all 0.3s;
  box-shadow:0 5px 15px rgba(102,126,234,0.4);
}
#resetButton:hover{
  transform:translateY(-2px);
  box-shadow:0 8px 20px rgba(102,126,234,0.6);
}
canvas{display:block;position:fixed;top:0;left:0;z-index:1;}
</style>
</head>

<body>

<div id="ui">
  <h2 style="margin:0 0 15px 0;color:#764ba2;text-align:center;font-size:24px;text-shadow:0 0 15px rgba(118,75,162,0.3);">ÔøΩ L·∫¨T TH·∫∫ GI·∫¨T GI·∫¢I üéâ</h2>
  
  <div class="form-group">
    <label>üé≠ Danh s√°ch ng∆∞·ªùi tham gia:</label>
    <textarea id="players" rows="6" placeholder="M·ªói d√≤ng 1 Var...">Var Nguy·ªÖn
Var Tr·∫ßn
Var L√™
Var Ph·∫°m
Var Ho√†ng
Var V√µ</textarea>
  </div>
  
  <div class="form-group">
    <label>üéØ S·ªë gi·∫£i th∆∞·ªüng:</label>
    <input id="targetDrunks" type="number" value="3" min="1">
  </div>
  
  <button id="start">üéä B·∫ÆT ƒê·∫¶U L·∫¨T TH·∫∫!</button>
</div>

<div id="hud">
  <div id="status">üéâ S·∫µn s√†ng l·∫≠t th·∫ª!</div>
  <div id="caughtList"></div>
</div>

<div id="instruction">
  üñ±Ô∏è B·∫§M V√ÄO TH·∫∫ ƒê·ªÇ L·∫¨T! üéÅ<br>
  <span style="font-size:14px;">üîç Scroll chu·ªôt: Zoom | ‚å®Ô∏è WASD: Di chuy·ªÉn | QE: L√™n/Xu·ªëng</span>
</div>

<!-- Popup overlay -->
<div id="popupOverlay">
  <div id="popup">
    <div id="popupContent"></div>
    <button id="popupButton">TI·∫æP T·ª§C L·∫¨T TH·∫∫ üÉè</button>
  </div>
</div>

<!-- THREE.JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

<script>
/* ================= GAME DATA ================= */
let names=[];
let targetPrizes=3;
let winners=[];
let flippedCards=[];
let isGameRunning=false;
let isPaused=false;

// Camera zoom control
let cameraZoom=1;
let minZoom=0.3;
let maxZoom=2.5;
let baseCameraY=35;
let baseCameraZ=25;

// Camera movement control
const keys={};
const cameraMoveSpeed=1.5;

let cards=[];
let spotlights=[];
let currentSpotlight=null;
let hoveredCard=null;
let lightnings=[];

/* ================= SCENE SETUP ================= */
const scene=new THREE.Scene();
scene.background=new THREE.Color(0x87ceeb);
scene.fog=new THREE.Fog(0x87ceeb,100,400);

const camera=new THREE.PerspectiveCamera(80,innerWidth/innerHeight,0.1,1000);
camera.position.set(0,35,25);
camera.lookAt(0,0,0);

const renderer=new THREE.WebGLRenderer({antialias:true,alpha:true});
renderer.setSize(innerWidth,innerHeight);
renderer.shadowMap.enabled=true;
renderer.shadowMap.type=THREE.PCFSoftShadowMap;
document.body.appendChild(renderer.domElement);

const raycaster=new THREE.Raycaster();
const mouse=new THREE.Vector2();

/* ================= LIGHTING ================= */
scene.add(new THREE.AmbientLight(0xffffff,0.8));
const sun=new THREE.DirectionalLight(0xfff4e0,1.1);
sun.position.set(-30,50,20);
sun.castShadow=true;
sun.shadow.mapSize.width=2048;
sun.shadow.mapSize.height=2048;
sun.shadow.camera.left=-60;
sun.shadow.camera.right=60;
sun.shadow.camera.top=60;
sun.shadow.camera.bottom=-60;
scene.add(sun);

const hemiLight=new THREE.HemisphereLight(0x87CEEB,0x228b22,0.6);
scene.add(hemiLight);

// Party lights with animation
const partyLights=[];
const partyLightColors=[0xff6b6b,0x4ecdc4,0xffe66d,0xaa96da];
const partyLightPositions=[[-25,20,25],[25,20,25],[25,20,-25],[-25,20,-25]];
partyLightPositions.forEach((pos,i)=>{
  const light=new THREE.PointLight(partyLightColors[i],0.9,50);
  light.position.set(...pos);
  partyLights.push(light);
  scene.add(light);
});

// Create spotlight pool for dramatic effect
for(let i=0;i<5;i++){
  const spotlight=new THREE.SpotLight(0xffd700,0,50,Math.PI/6,0.3,2);
  spotlight.position.set(0,30,0);
  spotlight.castShadow=true;
  spotlight.shadow.mapSize.width=1024;
  spotlight.shadow.mapSize.height=1024;
  spotlight.visible=false;
  spotlights.push(spotlight);
  scene.add(spotlight);
}

/* ================= FLOOR ================= */
const floor=new THREE.Mesh(
  new THREE.PlaneGeometry(400,400),
  new THREE.MeshStandardMaterial({
    color:0x808080,
    roughness:0.6,
    metalness:0.3
  })
);
floor.rotation.x=-Math.PI/2;
floor.receiveShadow=true;
scene.add(floor);

// Table surface for cards
const table=new THREE.Mesh(
  new THREE.PlaneGeometry(300,300),
  new THREE.MeshStandardMaterial({
    color:0x9a9a9a,
    roughness:0.4,
    metalness:0.2
  })
);
table.rotation.x=-Math.PI/2;
table.position.y=0.1;
table.receiveShadow=true;
scene.add(table);

// Party decorations
const balloonColors=[0xdc2626,0x0891b2,0xca8a04,0x7c3aed,0xdb2777];
for(let i=0;i<30;i++){
  const balloon=new THREE.Mesh(
    new THREE.SphereGeometry(0.6,10,10),
    new THREE.MeshStandardMaterial({
      color:balloonColors[i%balloonColors.length],
      roughness:0.2,
      metalness:0.3,
      emissive:balloonColors[i%balloonColors.length],
      emissiveIntensity:0.2
    })
  );
  const angle=Math.random()*Math.PI*2;
  const radius=50+Math.random()*30;
  balloon.position.set(
    Math.cos(angle)*radius,
    10+Math.random()*5,
    Math.sin(angle)*radius
  );
  scene.add(balloon);
}

// Confetti particles
const confettiParticles=[];
function createConfetti(){
  const confettiColors=[0xff6b81,0x70a1ff,0xfeca57,0x48dbfb,0xff6348];
  for(let i=0;i<50;i++){
    const geo=new THREE.BoxGeometry(0.2,0.2,0.05);
    const mat=new THREE.MeshStandardMaterial({
      color:confettiColors[Math.floor(Math.random()*confettiColors.length)],
      emissive:confettiColors[Math.floor(Math.random()*confettiColors.length)],
      emissiveIntensity:0.3
    });
    const c=new THREE.Mesh(geo,mat);
    c.position.set(
      (Math.random()-0.5)*60,
      -5,
      (Math.random()-0.5)*40
    );
    c.rotation.set(
      Math.random()*Math.PI,
      Math.random()*Math.PI,
      Math.random()*Math.PI
    );
    c.velocity={
      x:(Math.random()-0.5)*0.1,
      y:0.3+Math.random()*0.2,
      z:(Math.random()-0.5)*0.1,
      rotX:(Math.random()-0.5)*0.1,
      rotY:(Math.random()-0.5)*0.1,
      rotZ:(Math.random()-0.5)*0.1
    };
    confettiParticles.push(c);
    scene.add(c);
  }
}

/* ================= HELPER FUNCTIONS ================= */
function activateSpotlight(targetPos){
  if(currentSpotlight){
    currentSpotlight.visible=false;
  }
  
  const availableSpotlight=spotlights.find(s=>!s.visible)||spotlights[0];
  availableSpotlight.position.set(targetPos.x,30,targetPos.z);
  availableSpotlight.target.position.copy(targetPos);
  availableSpotlight.intensity=3;
  availableSpotlight.visible=true;
  
  currentSpotlight=availableSpotlight;
  scene.add(availableSpotlight.target);
}

function deactivateAllSpotlights(){
  spotlights.forEach(s=>{
    s.visible=false;
    s.intensity=0;
  });
  currentSpotlight=null;
}

function createLightning(targetPos){
  const geometry=new THREE.BufferGeometry();
  const vertices=[];
  const startY=40;
  const endY=targetPos.y+3;
  const segments=20;
  
  // T·∫°o ƒë∆∞·ªùng tia s√©t zigzag
  for(let i=0;i<=segments;i++){
    const t=i/segments;
    const y=startY-(startY-endY)*t;
    const offsetX=(Math.random()-0.5)*2*(1-t);
    const offsetZ=(Math.random()-0.5)*2*(1-t);
    vertices.push(targetPos.x+offsetX,y,targetPos.z+offsetZ);
  }
  
  geometry.setAttribute('position',new THREE.Float32BufferAttribute(vertices,3));
  
  const material=new THREE.LineBasicMaterial({
    color:0xffff00,
    linewidth:3,
    opacity:1,
    transparent:true
  });
  
  const lightning=new THREE.Line(geometry,material);
  lightning.userData={createdAt:Date.now(),duration:200};
  
  return lightning;
}

function updateLightnings(){
  const now=Date.now();
  
  // X√≥a tia s√©t c≈©
  for(let i=lightnings.length-1;i>=0;i--){
    const l=lightnings[i];
    const age=now-l.userData.createdAt;
    
    if(age>l.userData.duration){
      scene.remove(l);
      lightnings.splice(i,1);
    }else{
      // Fade out
      l.material.opacity=1-(age/l.userData.duration);
    }
  }
  
  // T·∫°o tia s√©t m·ªõi cho th·∫ª ƒëang hover
  if(hoveredCard && Math.random()<0.3){
    const lightning=createLightning(hoveredCard.position);
    scene.add(lightning);
    lightnings.push(lightning);
  }
}

function createTextTexture(text,bgColor='#ffffff',textColor='#764ba2',fontSize=100){
  const canvas=document.createElement('canvas');
  const context=canvas.getContext('2d');
  canvas.width=512;
  canvas.height=512;
  
  context.fillStyle=bgColor;
  context.fillRect(0,0,canvas.width,canvas.height);
  
  context.font=`bold ${fontSize}px Arial`;
  context.fillStyle=textColor;
  context.textAlign='center';
  context.textBaseline='middle';
  
  const words=text.split(' ');
  const lineHeight=fontSize*1.2;
  let lines=[];
  let currentLine=words[0];
  
  for(let i=1;i<words.length;i++){
    const testLine=currentLine+' '+words[i];
    const metrics=context.measureText(testLine);
    if(metrics.width>canvas.width-60){
      lines.push(currentLine);
      currentLine=words[i];
    }else{
      currentLine=testLine;
    }
  }
  lines.push(currentLine);
  
  const totalHeight=lines.length*lineHeight;
  const startY=(canvas.height-totalHeight)/2+lineHeight/2;
  
  // Draw text with shadow for better readability - ch·ªØ ƒëen ƒë·∫≠m
  lines.forEach((line,i)=>{
    const y=startY+i*lineHeight;
    // Shadow ƒëen ƒë·∫≠m
    context.fillStyle='rgba(0,0,0,0.5)';
    context.fillText(line,canvas.width/2+2,y+2);
    // Text ƒëen ƒë·∫≠m
    context.fillStyle=textColor;
    context.fillText(line,canvas.width/2,y);
  });
  
  const texture=new THREE.Texture(canvas);
  texture.needsUpdate=true;
  return texture;
}

function createCard(name,index){
  const cardGroup=new THREE.Group();
  
  // Card border/edge - k√≠ch th∆∞·ªõc v·ª´a ph·∫£i
  const edgeGeo=new THREE.BoxGeometry(4,5.5,0.15);
  const edgeMat=new THREE.MeshStandardMaterial({
    color:0xffa500,
    emissive:0xffa500,
    emissiveIntensity:0.2,
    roughness:0.3,
    metalness:0.7
  });
  const edgeMesh=new THREE.Mesh(edgeGeo,edgeMat);
  edgeMesh.castShadow=true;
  edgeMesh.receiveShadow=true;
  cardGroup.add(edgeMesh);
  
  // Card back (blue pattern - facing front initially)
  const backGeo=new THREE.PlaneGeometry(3.9,5.4);
  const backMat=new THREE.MeshStandardMaterial({
    color:0x667eea,
    emissive:0x667eea,
    emissiveIntensity:0.3,
    roughness:0.3,
    metalness:0.5,
    side:THREE.DoubleSide
  });
  const backMesh=new THREE.Mesh(backGeo,backMat);
  backMesh.position.z=0.08;
  cardGroup.add(backMesh);
  
  // Card front (white with name - facing back initially, will show when flipped)
  const frontTexture=createTextTexture(name,'#ffff99','#000000',90);
  const frontGeo=new THREE.PlaneGeometry(3.9,5.4);
  const frontMat=new THREE.MeshStandardMaterial({
    map:frontTexture,
    emissive:0xffffcc,
    emissiveIntensity:0.4,
    roughness:0.1,
    metalness:0.05,
    side:THREE.DoubleSide
  });
  const frontMesh=new THREE.Mesh(frontGeo,frontMat);
  frontMesh.position.z=-0.08;
  frontMesh.rotation.y=Math.PI; // Rotate ƒë·ªÉ ch·ªØ ƒë√∫ng h∆∞·ªõng khi l·∫≠t
  cardGroup.add(frontMesh);
  
  cardGroup.userData={
    name:name,
    index:index,
    isFlipped:false,
    isFlipping:false,
    targetRotation:0,
    backMesh:backMesh,
    frontMesh:frontMesh,
    edgeMesh:edgeMesh,
    clickable:edgeMesh
  };
  
  return cardGroup;
}

function arrangeCards(count){
  // T√≠nh to√°n ƒë·ªÉ th·∫ª v·ª´a v·ªõi m√†n h√¨nh
  const cols=Math.min(20,Math.ceil(Math.sqrt(count*1.4)));
  const rows=Math.ceil(count/cols);
  const spacingX=5;
  const spacingZ=6.5;
  const offsetX=(cols-1)*spacingX/2;
  const offsetZ=(rows-1)*spacingZ/2;
  
  for(let i=0;i<count;i++){
    const col=i%cols;
    const row=Math.floor(i/cols);
    const x=col*spacingX-offsetX;
    const z=row*spacingZ-offsetZ;
    
    cards[i].position.set(x,3.5,z);
    cards[i].rotation.set(0,0,0);
    cards[i].userData.targetRotation=0;
  }
  
  // T·ª± ƒë·ªông ƒëi·ªÅu ch·ªânh camera ƒë·ªÉ th·∫•y t·∫•t c·∫£
  const totalWidth=cols*spacingX;
  const totalHeight=rows*spacingZ;
  const maxDim=Math.max(totalWidth,totalHeight);
  const optimalDistance=maxDim*0.85;
  const optimalHeight=maxDim*0.75;
  
  baseCameraY=optimalHeight;
  baseCameraZ=optimalDistance;
  cameraZoom=1;
  
  camera.position.y=baseCameraY;
  camera.position.z=baseCameraZ;
  camera.lookAt(0,0,0);
}

function buildCardGame(playerNames){
  cards.forEach(c=>scene.remove(c));
  cards=[];
  
  playerNames.forEach((name,i)=>{
    const card=createCard(name,i);
    scene.add(card);
    cards.push(card);
  });
  
  arrangeCards(playerNames.length);
  deactivateAllSpotlights();
}

/* ================= GAME LOGIC ================= */
function startGame(){
  if(isGameRunning){
    alert("üéâ Game ƒëang ch·∫°y r·ªìi!");
    return;
  }
  
  names=document.getElementById("players").value
    .split("\n").map(s=>s.trim()).filter(Boolean);
  
  if(names.length<2){
    alert("üé≠ C·∫ßn √≠t nh·∫•t 2 ng∆∞·ªùi ƒë·ªÉ ch∆°i!");
    return;
  }
  
  targetPrizes=parseInt(document.getElementById("targetDrunks").value)||3;
  
  if(targetPrizes>names.length){
    alert("üéØ S·ªë gi·∫£i kh√¥ng th·ªÉ nhi·ªÅu h∆°n s·ªë ng∆∞·ªùi tham gia!");
    return;
  }
  
  winners=[];
  flippedCards=[];
  isGameRunning=true;
  isPaused=false;
  
  document.getElementById("ui").style.display="none";
  document.getElementById("instruction").style.display="block";
  
  buildCardGame(names);
  updateHUD();
}

function flipCard(cardIndex){
  if(!isGameRunning) return;
  
  const card=cards[cardIndex];
  if(card.userData.isFlipped || card.userData.isFlipping) return;
  if(flippedCards.includes(cardIndex)) return;
  
  card.userData.isFlipping=true;
  isPaused=true;
  
  // Activate spotlight on this card
  activateSpotlight(card.position);
  
  // Start flip animation
  card.userData.targetRotation=Math.PI;
  
  setTimeout(()=>{
    card.userData.isFlipped=true;
    card.userData.isFlipping=false;
    flippedCards.push(cardIndex);
    
    announceWinner(cardIndex);
  },800);
}

function announceWinner(cardIndex){
  const winnerName=names[cardIndex];
  
  const popup=document.getElementById("popupOverlay");
  const popupDiv=document.getElementById("popup");
  const content=document.getElementById("popupContent");
  
  popupDiv.classList.remove('large');
  
  content.innerHTML=`
    <div class="party-title">üéÅ GI·∫¨T GI·∫¢I TH√ÄNH C√îNG!</div>
    <h2 style="text-align:center;font-size:32px;">üé≠ ${winnerName}</h2>
    <div class="status-badge status-drunk" style="background:linear-gradient(135deg,#ffd700,#ffed4e);color:#764ba2;">
      üèÜ ƒê·∫†T GI·∫¢I!
    </div>
    <div class="gift-box">üéÅ</div>
    <div class="drunk-detail" style="background:linear-gradient(135deg,#ffd700,#ffed4e);border-color:#ff6b6b;">
      <div style="font-size:40px;margin-top:10px;">üéä‚ú®üéâ</div>
    </div>
    <p style="text-align:center;color:#764ba2;font-weight:700;margin-top:20px;font-size:18px;animation:pulse 1s infinite;">
      üåü Ch√∫c m·ª´ng b·∫°n ƒë√£ gi·∫≠t ƒë∆∞·ª£c gi·∫£i! üåü
    </p>
  `;
  
  // Change card to gold color
  cards[cardIndex].userData.edgeMesh.material.color.setHex(0xffd700);
  cards[cardIndex].userData.edgeMesh.material.emissive.setHex(0xffaa00);
  cards[cardIndex].userData.edgeMesh.material.emissiveIntensity=0.8;
  
  winners.push({name:winnerName});
  updateHUD();
  
  document.getElementById("popupButton").style.display="block";
  popup.style.display="flex";
}

function continueGame(){
  const popup=document.getElementById("popupOverlay");
  popup.style.display="none";
  
  deactivateAllSpotlights();
  isPaused=false;
  
  if(winners.length>=targetPrizes){
    showFinalReport();
  }else if(flippedCards.length>=names.length){
    showFinalReport();
  }
}

function showFinalReport(){
  isGameRunning=false;
  document.getElementById("instruction").style.display="none";
  deactivateAllSpotlights();
  
  const popup=document.getElementById("popupOverlay");
  const popupDiv=document.getElementById("popup");
  const content=document.getElementById("popupContent");
  
  popupDiv.classList.add('large');
  
  createConfetti();
  
  let reportHTML=`
    <div class="party-title">üéâ C√îNG B·ªê K·∫æT QU·∫¢!</div>
    <h2 style="color:#ffd700;">üèÜ ${winners.length} ng∆∞·ªùi may m·∫Øn tr√∫ng gi·∫£i!</h2>
  `;
  
  if(winners.length>0){
    reportHTML+=`
      <p style="font-weight:700;margin-bottom:20px;font-size:18px;text-align:center;color:#764ba2;">
        üéÅ Danh s√°ch ng∆∞·ªùi tr√∫ng gi·∫£i:
      </p>
      <div id="finalReport">
    `;
    
    winners.forEach((item,idx)=>{
      reportHTML+=`
        <div class="report-item">
          <strong>üé≠ ${idx+1}. ${item.name}</strong>
          <span class="gift-text">üèÜ ƒê·∫°t gi·∫£i</span>
        </div>
      `;
    });
    
    reportHTML+=`</div>`;
  }else{
    reportHTML+=`
      <p style="text-align:center;font-size:18px;color:#667eea;margin:20px 0;">
        üòÆ Ch∆∞a c√≥ ai tr√∫ng gi·∫£i!
      </p>
    `;
  }
  
  reportHTML+=`
    <p style="text-align:center;font-weight:700;color:#667eea;margin:20px 0;font-size:16px;">
      üéä C·∫£m ∆°n ƒë√£ tham gia! H·∫πn g·∫∑p l·∫°i! üéÅ
    </p>
    <button id="copyButton">üìã COPY DANH S√ÅCH</button>
    <button id="resetButton">üîÑ QUAY S·ªê L·∫†I</button>
  `;
  
  content.innerHTML=reportHTML;
  popup.style.display="flex";
  
  document.getElementById("copyButton").addEventListener("click",copyWinnerList);
  document.getElementById("resetButton").addEventListener("click",resetGame);
}

function copyWinnerList(){
  let text="üéÅ DANH S√ÅCH NG∆Ø·ªúI TR√öNG GI·∫¢I üèÜ\n";
  text+="=".repeat(50)+"\n\n";
  
  if(winners.length>0){
    winners.forEach((item,idx)=>{
      text+=`${idx+1}. üé≠ ${item.name}\n`;
      text+=`   üèÜ ƒê·∫°t gi·∫£i\n\n`;
    });
    
    text+="=".repeat(50)+"\n";
    text+=`üéä T·ªïng s·ªë ng∆∞·ªùi tr√∫ng gi·∫£i: ${winners.length}\n`;
  }else{
    text+="Ch∆∞a c√≥ ai tr√∫ng gi·∫£i!\n";
  }
  
  text+="üéâ C·∫£m ∆°n ƒë√£ tham gia!";
  
  navigator.clipboard.writeText(text).then(()=>{
    const btn=document.getElementById("copyButton");
    const originalText=btn.innerText;
    btn.innerText="‚úì ƒê√É COPY!";
    
    setTimeout(()=>{
      btn.innerText=originalText;
    },2000);
  }).catch(err=>{
    alert("Kh√¥ng th·ªÉ copy: "+err);
  });
}

function resetGame(){
  const popup=document.getElementById("popupOverlay");
  const popupDiv=document.getElementById("popup");
  popup.style.display="none";
  popupDiv.classList.remove('large');
  document.getElementById("ui").style.display="block";
  document.getElementById("instruction").style.display="none";
  
  confettiParticles.forEach(c=>scene.remove(c));
  confettiParticles.length=0;
  
  deactivateAllSpotlights();
  
  isGameRunning=false;
  isPaused=false;
  winners=[];
  flippedCards=[];
  updateHUD();
}

function updateHUD(){
  const status=document.getElementById("status");
  const list=document.getElementById("caughtList");
  
  if(!isGameRunning){
    status.innerText="ÔøΩ S·∫µn s√†ng quay s·ªë!";
    list.innerHTML='';
    return;
  }
  
  status.innerHTML=`
    <strong>üéØ ƒê√£ tr√∫ng:</strong> ${winners.length}/${targetPrizes}<br>
    <strong>üÉè ƒê√£ l·∫≠t:</strong> ${flippedCards.length}/${names.length}<br>
    <span style="color:#667eea;font-size:13px;font-weight:600;">
      ${isPaused?'‚è∏Ô∏è ƒêang x·ª≠ l√Ω...':'üñ±Ô∏è B·∫•m th·∫ª ƒë·ªÉ l·∫≠t!'}
    </span>
  `;
  
  if(winners.length>0){
    let listHTML='<strong style="color:#ffd700;">üèÜ Ng∆∞·ªùi tr√∫ng gi·∫£i:</strong><br>';
    winners.forEach((item,idx)=>{
      listHTML+=`
        <div class="drunk-item">
          ${idx+1}. <strong style="color:#ffd700;">${item.name}</strong><br>
          <span style="color:#764ba2;font-size:12px;">üéÅ ƒê·∫°t gi·∫£i</span>
        </div>
      `;
    });
    list.innerHTML=listHTML;
  }else{
    list.innerHTML='<em style="color:#9ca3af;">Ch∆∞a c√≥ ai tr√∫ng gi·∫£i...</em>';
  }
}

/* ================= ANIMATION ================= */
function animate(){
  requestAnimationFrame(animate);
  
  const time=Date.now()*0.001;
  
  // Camera movement with WASD
  if(keys['w'] || keys['W']){
    camera.position.z-=cameraMoveSpeed;
  }
  if(keys['s'] || keys['S']){
    camera.position.z+=cameraMoveSpeed;
  }
  if(keys['a'] || keys['A']){
    camera.position.x-=cameraMoveSpeed;
  }
  if(keys['d'] || keys['D']){
    camera.position.x+=cameraMoveSpeed;
  }
  if(keys['q'] || keys['Q']){
    camera.position.y+=cameraMoveSpeed;
  }
  if(keys['e'] || keys['E']){
    camera.position.y-=cameraMoveSpeed;
  }
  camera.lookAt(0,0,0);
  
  // Update lightnings
  updateLightnings();
  
  // Animate party lights
  partyLights.forEach((light,i)=>{
    light.intensity=0.7+Math.sin(time*2+i)*0.3;
  });
  
  // Animate spotlights
  spotlights.forEach((light,i)=>{
    if(light.visible){
      light.intensity=2.5+Math.sin(time*5+i)*0.8;
      light.angle=Math.PI/6+Math.sin(time*3)*0.05;
    }
  });
  
  // Animate cards floating
  cards.forEach((card,i)=>{
    if(!card.userData.isFlipping && !card.userData.isFlipped){
      card.position.y=3.5+Math.sin(time*2+i*0.5)*0.15;
      card.rotation.z=Math.sin(time+i)*0.02;
    }
    
    // Flip animation
    if(card.userData.isFlipping){
      const targetY=card.userData.targetRotation;
      const currentY=card.rotation.y;
      const diff=targetY-currentY;
      card.rotation.y+=diff*0.15;
      
      if(Math.abs(diff)<0.01){
        card.rotation.y=targetY;
      }
    }
  });
  
  // Animate confetti
  confettiParticles.forEach(c=>{
    c.position.x+=c.velocity.x;
    c.position.y+=c.velocity.y;
    c.position.z+=c.velocity.z;
    
    c.rotation.x+=c.velocity.rotX;
    c.rotation.y+=c.velocity.rotY;
    c.rotation.z+=c.velocity.rotZ;
    
    c.velocity.y-=0.01;
    
    if(c.position.y<-5){
      c.position.y=25;
      c.velocity.y=0.3+Math.random()*0.2;
    }
  });
  
  // Camera gentle movement
  if(isGameRunning && !isPaused){
    camera.position.x=Math.sin(time*0.2)*3;
    camera.lookAt(0,0,0);
  }
  
  renderer.render(scene,camera);
}
animate();

/* ================= EVENT LISTENERS ================= */
document.getElementById("start").addEventListener("click",startGame);
document.getElementById("popupButton").addEventListener("click",continueGame);

// Mouse wheel zoom
renderer.domElement.addEventListener("wheel",(event)=>{
  event.preventDefault();
  
  const delta=event.deltaY>0?0.9:1.1;
  cameraZoom*=delta;
  cameraZoom=Math.max(minZoom,Math.min(maxZoom,cameraZoom));
  
  // C·∫≠p nh·∫≠t camera position d·ª±a tr√™n zoom (zoom out = tƒÉng kho·∫£ng c√°ch)
  camera.position.y=baseCameraY/cameraZoom;
  camera.position.z=baseCameraZ/cameraZoom;
  camera.lookAt(0,0,0);
},{passive:false});

// Click to flip card
renderer.domElement.addEventListener("click",(event)=>{
  if(!isGameRunning || isPaused) return;
  
  mouse.x=(event.clientX/window.innerWidth)*2-1;
  mouse.y=-(event.clientY/window.innerHeight)*2+1;
  
  raycaster.setFromCamera(mouse,camera);
  
  const clickableObjects=cards.map(c=>c.userData.clickable);
  const intersects=raycaster.intersectObjects(clickableObjects);
  
  if(intersects.length>0){
    const clickedCard=cards.find(c=>c.userData.clickable===intersects[0].object);
    if(clickedCard){
      const cardIndex=clickedCard.userData.index;
      if(!flippedCards.includes(cardIndex) && !clickedCard.userData.isFlipped && !clickedCard.userData.isFlipping){
        flipCard(cardIndex);
      }
    }
  }
});

// Keyboard controls
document.addEventListener('keydown',(e)=>{
  keys[e.key]=true;
});

document.addEventListener('keyup',(e)=>{
  keys[e.key]=false;
});

// Hover effect for visual feedback
renderer.domElement.addEventListener("mousemove",(event)=>{
  if(!isGameRunning || isPaused) return;
  
  mouse.x=(event.clientX/window.innerWidth)*2-1;
  mouse.y=-(event.clientY/window.innerHeight)*2+1;
  
  raycaster.setFromCamera(mouse,camera);
  
  const clickableObjects=cards.map(c=>c.userData.clickable);
  const intersects=raycaster.intersectObjects(clickableObjects);
  
  // Reset t·∫•t c·∫£ th·∫ª v·ªÅ tr·∫°ng th√°i b√¨nh th∆∞·ªùng
  hoveredCard=null;
  cards.forEach(card=>{
    if(!card.userData.isFlipped && !card.userData.isFlipping){
      card.userData.edgeMesh.material.emissiveIntensity=0.2;
      card.scale.set(1,1,1);
      card.userData.backMesh.material.emissiveIntensity=0.3;
    }
  });
  
  if(intersects.length>0){
    const hCard=cards.find(c=>c.userData.clickable===intersects[0].object);
    if(hCard && !hCard.userData.isFlipped && !hCard.userData.isFlipping){
      hoveredCard=hCard;
      // Chi·∫øu s√°ng m·∫°nh th·∫ª ƒë∆∞·ª£c hover
      hCard.userData.edgeMesh.material.emissiveIntensity=1.2;
      hCard.userData.backMesh.material.emissiveIntensity=0.8;
      hCard.scale.set(1.15,1.15,1.15);
      renderer.domElement.style.cursor='pointer';
      return;
    }
  }
  
  renderer.domElement.style.cursor='default';
});

window.addEventListener("resize",()=>{
  camera.aspect=innerWidth/innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth,innerHeight);
});

console.log("ÔøΩ L·∫≠t Th·∫ª Gi·∫≠t Gi·∫£i ready! Good luck! üèÜ");
</script>
</body>
</html>
