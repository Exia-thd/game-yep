<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8">
<title>ğŸ» Check Var Say Xá»‰n â€“ Party TMA 3D ğŸ‰</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
html,body{
  margin:0;height:100%;
  background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
  font-family:'Comic Sans MS',cursive,system-ui,Arial;
  color:#0b1020;
}
#ui{
  position:fixed;top:12px;left:12px;width:380px;
  background:rgba(255,255,255,.96);
  border-radius:20px;padding:20px;
  box-shadow:0 15px 40px rgba(102,126,234,.5);
  z-index:10;
  border:3px solid #ffa500;
}
.form-group{
  margin-bottom:14px;
}
.form-group label{
  display:block;
  font-weight:700;
  margin-bottom:6px;
  color:#764ba2;
  font-size:15px;
}
textarea,input{
  width:100%;padding:10px;
  border-radius:12px;border:2px solid #667eea;
  font-family:inherit;
  transition:all 0.3s;
}
textarea:focus,input:focus{
  outline:none;
  border-color:#ffd700;
  box-shadow:0 0 0 3px rgba(255,215,0,0.2);
}
button{
  width:100%;padding:14px;border-radius:12px;
  border:none;font-weight:700;cursor:pointer;
  background:linear-gradient(135deg,#ffa500,#ffb84d);
  color:#764ba2;
  font-size:16px;
  transition:all 0.3s;
  box-shadow:0 5px 15px rgba(255,165,0,0.4);
}
button:hover{
  transform:translateY(-2px);
  box-shadow:0 8px 20px rgba(255,165,0,0.6);
}
#hud{
  position:fixed;right:12px;top:12px;width:340px;
  background:rgba(255,255,255,.95);
  border-radius:20px;padding:16px;
  box-shadow:0 15px 40px rgba(102,126,234,.4);
  z-index:10;
  border:3px solid #667eea;
}
#status{
  font-size:15px;
  font-weight:600;
  margin-bottom:10px;
  color:#764ba2;
}
#caughtList{
  font-size:13px;
  line-height:1.7;
  max-height:250px;
  overflow-y:auto;
  padding:10px;
  background:rgba(102,126,234,0.08);
  border-radius:10px;
}
.drunk-item{
  padding:8px 0;
  border-bottom:2px solid rgba(255,165,0,0.3);
  animation:slideIn 0.5s ease-out;
}
.drunk-item:last-child{
  border-bottom:none;
}
@keyframes slideIn{
  from{opacity:0;transform:translateX(20px);}
  to{opacity:1;transform:translateX(0);}
}

/* Popup overlay */
#popupOverlay{
  position:fixed;
  top:0;left:0;right:0;bottom:0;
  background:rgba(102,126,234,0.85);
  display:none;
  z-index:100;
  align-items:center;
  justify-content:center;
}
#popup{
  background:linear-gradient(145deg,#ffffff,#f8f9ff);
  border-radius:24px;
  padding:32px;
  max-width:550px;
  width:92%;
  box-shadow:0 25px 70px rgba(0,0,0,.4);
  border:4px solid #ffa500;
  animation:popIn 0.4s cubic-bezier(0.68,-0.55,0.265,1.55);
  box-sizing:border-box;
  overflow:hidden;
}
@keyframes popIn{
  from{transform:scale(0.5);opacity:0;}
  to{transform:scale(1);opacity:1;}
}
#popup.large{
  max-width:750px;
  max-height:88vh;
  overflow-y:auto;
}
#popup h2{
  margin:0 0 18px 0;
  color:#764ba2;
  font-size:28px;
  text-align:center;
  word-wrap:break-word;
  overflow-wrap:break-word;
}
.party-title{
  color:#ffa500;
  font-size:36px;
  font-weight:900;
  margin:10px 0;
  text-shadow:2px 2px 0 #764ba2;
  text-align:center;
  box-sizing:border-box;
}
.status-badge{
  display:inline-block;
  padding:10px 20px;
  border-radius:12px;
  font-weight:700;
  font-size:18px;
  margin:15px 0;
  text-align:center;
  width:100%;
  animation:bounce 0.6s ease-in-out;
  box-sizing:border-box;
}
@keyframes bounce{
  0%,100%{transform:scale(1);}
  50%{transform:scale(1.05);}
}
.status-ok{
  background:linear-gradient(135deg,#00d2ff,#3a7bd5);
  color:white;
  box-shadow:0 5px 15px rgba(0,210,255,0.4);
}
.status-drunk{
  background:linear-gradient(135deg,#ff6b6b,#ee5a6f);
  color:white;
  box-shadow:0 5px 15px rgba(255,107,107,0.4);
}
.drunk-detail{
  background:linear-gradient(135deg,#ffe66d,#ffed4e);
  border-left:5px solid #ffa500;
  padding:16px;
  border-radius:10px;
  margin:15px 0;
  font-size:15px;
  color:#764ba2;
  font-weight:600;
  text-align:center;
  word-wrap:break-word;
  overflow-wrap:break-word;
  max-width:100%;
  box-sizing:border-box;
}
#popupButton{
  width:100%;
  margin-top:20px;
  padding:14px;
  background:linear-gradient(135deg,#667eea,#764ba2);
  color:white;
  border:none;
  border-radius:12px;
  font-weight:700;
  font-size:17px;
  cursor:pointer;
  transition:all 0.3s;
  box-shadow:0 5px 15px rgba(102,126,234,0.4);
}
#popupButton:hover{
  transform:translateY(-2px);
  box-shadow:0 8px 20px rgba(102,126,234,0.6);
}

/* Final report popup */
#finalReport{
  max-height:600px;
  overflow-y:auto;
  margin-bottom:18px;
}
.report-item{
  padding:16px 20px;
  background:linear-gradient(135deg,#fff,#f8f9ff);
  border-radius:12px;
  margin-bottom:15px;
  border-left:5px solid #ffa500;
  font-size:16px;
  box-shadow:0 3px 10px rgba(0,0,0,0.1);
}
.report-item strong{
  font-size:18px;
  color:#764ba2;
}
.report-item .drunk-text{
  color:#ff6b6b;
  margin-top:6px;
  display:block;
  font-weight:600;
}
.loading-spinner{
  display:inline-block;
  width:60px;
  height:60px;
  border:6px solid #f0f0f0;
  border-top:6px solid #667eea;
  border-radius:50%;
  animation:spin 1s linear infinite;
  margin:25px auto;
}
@keyframes spin{
  0%{transform:rotate(0deg);}
  100%{transform:rotate(360deg);}
}
.loading-text{
  text-align:center;
  color:#764ba2;
  font-size:16px;
  margin-top:15px;
  font-weight:600;
}
#copyButton{
  width:100%;
  margin-bottom:10px;
  padding:14px;
  background:linear-gradient(135deg,#00d2ff,#3a7bd5);
  color:white;
  border:none;
  border-radius:12px;
  font-weight:700;
  font-size:17px;
  cursor:pointer;
  transition:all 0.3s;
  box-shadow:0 5px 15px rgba(0,210,255,0.4);
}
#copyButton:hover{
  transform:translateY(-2px);
  box-shadow:0 8px 20px rgba(0,210,255,0.6);
}
#resetButton{
  width:100%;
  padding:14px;
  background:linear-gradient(135deg,#667eea,#764ba2);
  color:white;
  border:none;
  border-radius:12px;
  font-weight:700;
  font-size:17px;
  cursor:pointer;
  transition:all 0.3s;
  box-shadow:0 5px 15px rgba(102,126,234,0.4);
}
#resetButton:hover{
  transform:translateY(-2px);
  box-shadow:0 8px 20px rgba(102,126,234,0.6);
}
#popupContent{
  overflow:hidden;
  box-sizing:border-box;
}
canvas{display:block}
</style>
</head>

<body>

<div id="ui">
  <h2 style="margin:0 0 15px 0;color:#764ba2;text-align:center;font-size:24px;">ğŸ» CHECK VAR SAY Xá»ˆN ğŸ‰</h2>
  
  <div class="form-group">
    <label>ğŸ­ Danh sÃ¡ch Var tham gia party:</label>
    <textarea id="players" rows="6" placeholder="Má»—i dÃ²ng 1 Var...">Var Nguyá»…n
Var Tráº§n
Var LÃª
Var Pháº¡m
Var HoÃ ng
Var VÃµ</textarea>
  </div>
  
  <div class="form-group">
    <label>ğŸ¯ Sá»‘ Var say xá»‰n cáº§n tÃ¬m Ä‘á»ƒ loáº¡i:</label>
    <input id="targetDrunks" type="number" value="3" min="1">
  </div>
  
  <div class="form-group">
    <label>ğŸº Tá»· lá»‡ Var cÃ²n tá»‰nh tÃ¡o (%):</label>
    <input id="soberRate" type="number" value="70" min="0" max="100">
  </div>
  
  <div class="form-group">
    <label>â±ï¸ Thá»i gian giá»¯a má»—i láº§n check (giÃ¢y):</label>
    <input id="checkInterval" type="number" value="2" min="1" max="10">
  </div>
  
  <button id="start">ğŸŠ Báº®T Äáº¦U PARTY!</button>
</div>

<div id="hud">
  <div id="status">ğŸ‰ Sáºµn sÃ ng check Var!</div>
  <div id="caughtList"></div>
</div>

<!-- Popup overlay -->
<div id="popupOverlay">
  <div id="popup">
    <div id="popupContent"></div>
    <button id="popupButton">TIáº¾P Tá»¤C CHECK ğŸ»</button>
  </div>
</div>

<!-- THREE.JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

<script>
/* ================= GAME DATA ================= */
let names=[];
let targetDrunks=3;
let checkInterval=2;

/* ================= BACKGROUND MUSIC ================= */
let backgroundMusic=new Audio();
backgroundMusic.volume=1.0;

const musicTracks=[
  'Music/edm-gaming-music-335408.mp3',
  'Music/level-up-energetic-gaming-rock-music-251284.mp3',
  'Music/victory-awaits-in-the-gaming-universe_astronaut-265184.mp3',
  'Music/gaming-game-minecraft-background-music-372242.mp3',
  'Music/retro-game-402454.mp3'
];

let currentTrackIndex=-1;

function playRandomMusic(){
  if(musicTracks.length===0) return;
  
  let newIndex;
  do{
    newIndex=Math.floor(Math.random()*musicTracks.length);
  }while(newIndex===currentTrackIndex && musicTracks.length>1);
  
  currentTrackIndex=newIndex;
  backgroundMusic.src=musicTracks[currentTrackIndex];
  backgroundMusic.play().catch(err=>console.log('Music play failed:',err));
}

function stopMusic(){
  backgroundMusic.pause();
  backgroundMusic.currentTime=0;
}

function playVictoryMusic(){
  backgroundMusic.src='Music/gaming-game-minecraft-background-music-387000.mp3';
  backgroundMusic.currentTime=0;
  backgroundMusic.play().catch(err=>console.log('Victory music play failed:',err));
}

// Auto-play next random track when current one ends
backgroundMusic.addEventListener('ended',()=>{
  playRandomMusic();
});
let soberRate=70;
let caughtDrunks=[];
let checkedDrunks=[];
let isGameRunning=false;
let isPaused=false;

let checker=null;
let checkerPosition={x:0,y:0,z:0};
let checkerTarget=null;
let patrolSpeed=0.15;
let checkingVar=false;
let currentCheckIndex=-1;

let desks=[];
let persons=[];
let labels=[];
let varStates=[];
let varDrunkLevels=[];

const DRUNK_REASONS=[
  "ğŸº Nháº­n thÃ¡ch Ä‘áº¥u vá»›i sáº¿p vÃ  thua",
  "ğŸ¥ƒ Uá»‘ng liÃªn tá»¥c 5 shot tequila",
  "ğŸ» Cáº¡nh tranh uá»‘ng vá»›i team bÃªn cáº¡nh",
  "ğŸ· Say vÃ¬ rÆ°á»£u vang quÃ¡ ngon",
  "ğŸ‰ QuÃ¡ vui nÃªn uá»‘ng khÃ´ng kÃ¬m Ä‘Æ°á»£c",
  "ğŸ˜­ Uá»‘ng Ä‘á»ƒ quÃªn Ä‘i code bug",
  "ğŸŠ Ä‚n má»«ng tÄƒng lÆ°Æ¡ng quÃ¡ sung",
  "ğŸ¤ª Tá»± thÃ¡ch Ä‘áº¥u vá»›i chÃ­nh mÃ¬nh",
  "ğŸµ HÃ¡t karaoke vÃ  uá»‘ng theo nhá»‹p",
  "ğŸ’ª Muá»‘n chá»©ng minh tá»­u lÆ°á»£ng cá»§a mÃ¬nh",
  "ğŸ¾ Má»Ÿ champagne nhÆ°ng uá»‘ng luÃ´n cáº£ chai",
  "ğŸ˜´ Uá»‘ng Ä‘á»ƒ... dá»… ngá»§ sau party"
];

// Track usage for variety
let giftWeights=[];
let drunkReasonWeights=[];

/* ================= SCENE SETUP ================= */
const scene=new THREE.Scene();
scene.background=new THREE.Color(0x87ceeb);

const camera=new THREE.PerspectiveCamera(55,innerWidth/innerHeight,0.1,500);
camera.position.set(0,25,35);
camera.lookAt(0,0,0);

let cameraDistance=Math.sqrt(camera.position.x**2+camera.position.y**2+camera.position.z**2);
let cameraAngleH=0;
let cameraAngleV=Math.PI/4;
let cameraTarget=new THREE.Vector3(0,0,0);
let isDragging=false;
let lastMouseX=0,lastMouseY=0;
let keys={};

const renderer=new THREE.WebGLRenderer({antialias:true});
renderer.setSize(innerWidth,innerHeight);
renderer.shadowMap.enabled=true;
document.body.appendChild(renderer.domElement);

/* ================= LIGHTING ================= */
scene.add(new THREE.AmbientLight(0xffffff,0.9));
const sun=new THREE.DirectionalLight(0xfff1cc,1.2);
sun.position.set(-30,50,20);
sun.castShadow=true;
sun.shadow.camera.left=-50;
sun.shadow.camera.right=50;
sun.shadow.camera.top=50;
sun.shadow.camera.bottom=-50;
scene.add(sun);

// Party lights
const partyLights=[
  {color:0xff6b6b,pos:[-20,15,20]},
  {color:0x4ecdc4,pos:[20,15,20]},
  {color:0xffe66d,pos:[20,15,-20]},
  {color:0xaa96da,pos:[-20,15,-20]}
];
partyLights.forEach(pl=>{
  const light=new THREE.PointLight(pl.color,0.8,40);
  light.position.set(...pl.pos);
  scene.add(light);
});

/* ================= FLOOR ================= */
const floor=new THREE.Mesh(
  new THREE.PlaneGeometry(300,300),
  new THREE.MeshStandardMaterial({color:0x505050})
);
floor.rotation.x=-Math.PI/2;
floor.receiveShadow=true;
scene.add(floor);

// Party decorations
const balloonColors=[0xdc2626,0x0891b2,0xca8a04,0x7c3aed,0xdb2777];
for(let i=0;i<20;i++){
  const balloon=new THREE.Mesh(
    new THREE.SphereGeometry(0.5,8,8),
    new THREE.MeshStandardMaterial({
      color:balloonColors[i%balloonColors.length],
      roughness:0.3
    })
  );
  const angle=Math.random()*Math.PI*2;
  const radius=40+Math.random()*20;
  balloon.position.set(
    Math.cos(angle)*radius,
    8+Math.random()*4,
    Math.sin(angle)*radius
  );
  scene.add(balloon);
}

/* ================= HELPER FUNCTIONS ================= */
function getWeightedRandom(array,weights){
  if(weights.length===0){
    weights=new Array(array.length).fill(1.0);
  }
  
  let totalWeight=weights.reduce((sum,w)=>sum+w,0);
  let random=Math.random()*totalWeight;
  let cumulative=0;
  
  for(let i=0;i<array.length;i++){
    cumulative+=weights[i];
    if(random<=cumulative){
      weights[i]*=0.5;
      return array[i];
    }
  }
  
  return array[0];
}

function createTextSprite(text,bgColor,textColor){
  if(!bgColor) bgColor='rgba(255,255,255,0.95)';
  if(!textColor) textColor='#764ba2';
  
  const canvas=document.createElement('canvas');
  const context=canvas.getContext('2d');
  canvas.width=1024;
  canvas.height=256;
  
  context.fillStyle=bgColor;
  context.fillRect(0,0,canvas.width,canvas.height);
  
  context.font='bold 96px Arial';
  context.fillStyle=textColor;
  context.textAlign='center';
  context.textBaseline='middle';
  context.fillText(text,512,128);
  
  const texture=new THREE.Texture(canvas);
  texture.needsUpdate=true;
  
  const spriteMaterial=new THREE.SpriteMaterial({map:texture});
  const sprite=new THREE.Sprite(spriteMaterial);
  sprite.scale.set(6,1.5,1);
  
  return sprite;
}

function updateTextSprite(sprite,text,bgColor,textColor){
  if(!bgColor) bgColor='rgba(255,255,255,0.95)';
  if(!textColor) textColor='#764ba2';
  
  const canvas=sprite.material.map.image;
  const context=canvas.getContext('2d');
  
  context.fillStyle=bgColor;
  context.fillRect(0,0,canvas.width,canvas.height);
  
  context.font='bold 96px Arial';
  context.fillStyle=textColor;
  context.textAlign='center';
  context.textBaseline='middle';
  context.fillText(text,512,128);
  
  sprite.material.map.needsUpdate=true;
}

function createPersonModel(isChecker=false){
  const group=new THREE.Group();
  
  const bodyColor=isChecker?0xd97706:0x3b82f6;
  
  const body=new THREE.Mesh(
    new THREE.BoxGeometry(0.6,0.8,0.4),
    new THREE.MeshStandardMaterial({color:bodyColor})
  );
  body.position.y=0.9;
  body.castShadow=true;
  group.add(body);
  
  const head=new THREE.Mesh(
    new THREE.SphereGeometry(0.25,8,8),
    new THREE.MeshStandardMaterial({color:0xffdbac})
  );
  head.position.y=1.5;
  head.castShadow=true;
  group.add(head);
  
  if(isChecker){
    // Party hat
    const hat=new THREE.Mesh(
      new THREE.ConeGeometry(0.3,0.5,8),
      new THREE.MeshStandardMaterial({color:0xff6b6b})
    );
    hat.position.y=1.95;
    hat.castShadow=true;
    group.add(hat);
    
    // Beer mug
    const mug=new THREE.Mesh(
      new THREE.CylinderGeometry(0.15,0.18,0.4,8),
      new THREE.MeshStandardMaterial({color:0xffd966,transparent:true,opacity:0.8})
    );
    mug.position.set(0.4,1.0,0.2);
    group.add(mug);
  }
  
  const armL=new THREE.Mesh(
    new THREE.BoxGeometry(0.15,0.6,0.15),
    new THREE.MeshStandardMaterial({color:bodyColor})
  );
  armL.position.set(-0.35,0.7,0);
  armL.castShadow=true;
  group.add(armL);
  
  const armR=new THREE.Mesh(
    new THREE.BoxGeometry(0.15,0.6,0.15),
    new THREE.MeshStandardMaterial({color:bodyColor})
  );
  armR.position.set(0.35,0.7,0);
  armR.castShadow=true;
  group.add(armR);
  
  const legL=new THREE.Mesh(
    new THREE.BoxGeometry(0.2,0.5,0.2),
    new THREE.MeshStandardMaterial({color:0x1e3a8a})
  );
  legL.position.set(-0.2,0.25,0);
  legL.castShadow=true;
  group.add(legL);
  
  const legR=new THREE.Mesh(
    new THREE.BoxGeometry(0.2,0.5,0.2),
    new THREE.MeshStandardMaterial({color:0x1e3a8a})
  );
  legR.position.set(0.2,0.25,0);
  legR.castShadow=true;
  group.add(legR);
  
  return group;
}

function createDesk(){
  const group=new THREE.Group();
  
  const top=new THREE.Mesh(
    new THREE.BoxGeometry(2.5,0.15,1.5),
    new THREE.MeshStandardMaterial({color:0xd1d5db})
  );
  top.position.y=0.75;
  top.castShadow=true;
  top.receiveShadow=true;
  group.add(top);
  
  const legPositions=[[-1,0.5],[-1,-0.5],[1,0.5],[1,-0.5]];
  legPositions.forEach(([dx,dz])=>{
    const leg=new THREE.Mesh(
      new THREE.BoxGeometry(0.08,0.7,0.08),
      new THREE.MeshStandardMaterial({color:0x9ca3af})
    );
    leg.position.set(dx,0.35,dz);
    leg.castShadow=true;
    group.add(leg);
  });
  
  // Beer bottles on desk
  for(let i=0;i<2;i++){
    const bottle=new THREE.Mesh(
      new THREE.CylinderGeometry(0.08,0.08,0.3,8),
      new THREE.MeshStandardMaterial({color:0x8b4513,transparent:true,opacity:0.7})
    );
    bottle.position.set(-0.5+i*1,0.9,0.3);
    group.add(bottle);
  }
  
  return group;
}

function buildParty(count){
  desks.forEach(d=>scene.remove(d));
  persons.forEach(p=>scene.remove(p));
  labels.forEach(l=>scene.remove(l));
  if(checker) scene.remove(checker);
  
  desks=[];
  persons=[];
  labels=[];
  varStates=[];
  varDrunkLevels=[];
  
  const cols=Math.ceil(Math.sqrt(count));
  const spacing=6;
  const offset=(cols-1)*spacing/2;

  for(let i=0;i<count;i++){
    const x=(i%cols)*spacing-offset;
    const z=Math.floor(i/cols)*spacing-offset;

    const desk=createDesk();
    desk.position.set(x,0,z);
    scene.add(desk);
    desks.push(desk);

    const person=createPersonModel(false);
    person.position.set(x,0.05,z+0.6);
    scene.add(person);
    persons.push(person);
    
    // Random drunk status
    const drunkChance=(100-soberRate)/100;
    if(Math.random()<drunkChance){
      varStates.push('drunk');
      varDrunkLevels.push(getWeightedRandom(DRUNK_REASONS,drunkReasonWeights));
    }else{
      varStates.push('sober');
      varDrunkLevels.push(null);
    }

    const label=createTextSprite(names[i]);
    label.position.set(x,3.5,z);
    scene.add(label);
    labels.push(label);
  }
  
  // Create checker (3x bigger)
  checker=createPersonModel(true);
  checker.scale.set(3,3,3);
  checker.position.set(0,0.05,0);
  scene.add(checker);
  
  const checkerLabel=createTextSprite("ğŸ» Check Var",'rgba(255,165,0,0.95)','#764ba2');
  checkerLabel.position.set(0,8,0);
  checkerLabel.scale.set(9,2.25,1);
  scene.add(checkerLabel);
  labels.push(checkerLabel);
  
  checkerPosition={x:0,y:0.05,z:0};
}

/* ================= GAME LOGIC ================= */
function startGame(){
  if(isGameRunning){
    alert("ğŸ‰ Party Ä‘ang diá»…n ra rá»“i!");
    return;
  }
  
  names=document.getElementById("players").value
    .split("\n").map(s=>s.trim()).filter(Boolean);
  
  if(names.length<2){
    alert("ğŸ­ Cáº§n Ã­t nháº¥t 2 Var Ä‘á»ƒ party!");
    return;
  }
  
  targetDrunks=parseInt(document.getElementById("targetDrunks").value)||3;
  checkInterval=parseInt(document.getElementById("checkInterval").value)||2;
  soberRate=parseInt(document.getElementById("soberRate").value)||70;
  
  if(soberRate<0) soberRate=0;
  if(soberRate>100) soberRate=100;
  
  if(targetDrunks>names.length){
    alert("ğŸ¯ Sá»‘ Var say xá»‰n khÃ´ng thá»ƒ nhiá»u hÆ¡n tá»•ng sá»‘ Var!");
    return;
  }
  
  caughtDrunks=[];
  checkedDrunks=[];
  drunkReasonWeights=[];
  isGameRunning=true;
  isPaused=false;
  checkingVar=false;
  currentCheckIndex=-1;
  checkerTarget=null;
  
  document.getElementById("ui").style.display="none";
  
  buildParty(names.length);
  updateHUD();
  
  // Start background music
  playRandomMusic();
  
  pickNextTarget();
}

function pickNextTarget(){
  if(!isGameRunning || isPaused) return;
  
  let availableVars=[];
  for(let i=0;i<persons.length;i++){
    if(!checkedDrunks.includes(i)){
      availableVars.push(i);
    }
  }
  
  if(availableVars.length===0){
    showFinalReport();
    return;
  }
  
  currentCheckIndex=availableVars[Math.floor(Math.random()*availableVars.length)];
  const targetPos=persons[currentCheckIndex].position;
  
  checkerTarget={
    x:targetPos.x,
    y:0.05,
    z:targetPos.z+3
  };
}

function checkVar(){
  if(!isGameRunning || checkingVar) return;
  
  checkingVar=true;
  isPaused=true;
  
  const varName=names[currentCheckIndex];
  const isDrunk=varStates[currentCheckIndex]==='drunk';
  const drunkReason=varDrunkLevels[currentCheckIndex];
  
  const popup=document.getElementById("popupOverlay");
  const popupDiv=document.getElementById("popup");
  const content=document.getElementById("popupContent");
  
  popupDiv.classList.remove('large');
  
  content.innerHTML=`
    <div class="party-title">ğŸ» TMA PARTY</div>
    <h2>ğŸ­ Check Var: ${varName}</h2>
    <div style="text-align:center;padding:25px 0;">
      <div class="loading-spinner"></div>
      <div class="loading-text">Äang kiá»ƒm tra tÃ¬nh tráº¡ng...</div>
    </div>
  `;
  
  document.getElementById("popupButton").style.display="none";
  popup.style.display="flex";
  
  setTimeout(()=>{
    if(isDrunk){
      checkedDrunks.push(currentCheckIndex);
      
      content.innerHTML=`
        <div class="party-title">ğŸ» TMA PARTY</div>
        <h2 style="text-align:center;">ğŸ­ ${varName}</h2>
        <div class="status-badge status-drunk">ğŸ˜µ ÄÃƒ SAY Xá»ˆN!</div>
        <div class="drunk-detail">
          <div><strong>ğŸº NguyÃªn nhÃ¢n:</strong></div>
          <div>${drunkReason}</div>
        </div>
        <p style="text-align:center;color:#ff6b6b;font-weight:700;margin-top:15px;font-size:16px;">
          ğŸ˜µ ÄÃ£ bá»‹ phÃ¡t hiá»‡n say xá»‰n!
        </p>
      `;
      
      updateTextSprite(labels[currentCheckIndex],varName,'rgba(255,107,107,0.95)','#ffffff');
      
      caughtDrunks.push({name:varName,reason:drunkReason});
      updateHUD();
      
    }else{
      const skipReasons=[
        "ğŸ’ª CÃ²n tá»‰nh tÃ¡o 100%",
        "ğŸš½ Äang Ä‘i vá»‡ sinh (skip táº¡m thá»i)",
        "ğŸ“± Äang gá»i Ä‘iá»‡n cho ngÆ°á»i yÃªu",
        "ğŸµ Äang hÃ¡t karaoke quÃ¡ say sÆ°a",
        "ğŸ• Äang Äƒn pizza Ä‘á»ƒ tá»‰nh rÆ°á»£u",
        "ğŸ’ƒ Äang nháº£y mÃºa quÃ¡ sung",
        "ğŸ“¸ Äang chá»¥p áº£nh check-in",
        "ğŸ® Äang chÆ¡i game trong gÃ³c"
      ];
      const skipReason=skipReasons[Math.floor(Math.random()*skipReasons.length)];
      
      content.innerHTML=`
        <div class="party-title">ğŸ» TMA PARTY</div>
        <h2 style="text-align:center;">ğŸ­ ${varName}</h2>
        <div class="status-badge status-ok">âœ¨ BÃŒNH THÆ¯á»œNG</div>
        <p style="text-align:center;color:#3a7bd5;font-weight:700;margin-top:20px;font-size:18px;">
          ${skipReason}
        </p>
        <p style="text-align:center;color:#667eea;font-weight:600;margin-top:15px;font-size:15px;">
          Tiáº¿p tá»¥c party! ğŸŠ
        </p>
      `;
    }
    
    document.getElementById("popupButton").style.display="block";
    
    // Auto continue after showing result
    setTimeout(()=>{
      if(isGameRunning && checkingVar){
        continueCheck();
      }
    },3000);
  },2000);
}

function continueCheck(){
  const popup=document.getElementById("popupOverlay");
  popup.style.display="none";
  
  checkingVar=false;
  
  if(caughtDrunks.length>=targetDrunks){
    showFinalReport();
  }else{
    isPaused=false;
    setTimeout(()=>{
      if(isGameRunning && !isPaused){
        pickNextTarget();
      }
    },checkInterval*1000);
  }
}

function showFinalReport(){
  isGameRunning=false;
  
  // Stop music and play victory music
  stopMusic();
  playVictoryMusic();
  
  const popup=document.getElementById("popupOverlay");
  const popupDiv=document.getElementById("popup");
  const content=document.getElementById("popupContent");
  
  popupDiv.classList.add('large');
  
  let reportHTML=`
    <div class="party-title">ğŸ‰ Káº¾T THÃšC PARTY!</div>
    <h2 style="color:#ffa500;">ğŸ† ÄÃ£ tÃ¬m Ä‘á»§ ${targetDrunks} Var say xá»‰n!</h2>
    <p style="font-weight:700;margin-bottom:20px;font-size:18px;text-align:center;color:#764ba2;">
      ğŸ“‹ Danh sÃ¡ch Var bá»‹ loáº¡i:
    </p>
    <div id="finalReport">
  `;
  
  caughtDrunks.forEach((item,idx)=>{
    reportHTML+=`
      <div class="report-item">
        <strong>ğŸ­ ${idx+1}. ${item.name}</strong>
        <span class="drunk-text">ğŸº ${item.reason}</span>
      </div>
    `;
  });
  
  reportHTML+=`</div>
    <p style="text-align:center;font-weight:700;color:#667eea;margin:20px 0;font-size:16px;">
      ğŸŠ ChÃºc má»«ng Ä‘Ã£ hoÃ n thÃ nh party! Háº¹n gáº·p láº¡i á»Ÿ party sau! ğŸ»
    </p>
    <button id="copyButton">ğŸ“‹ COPY DANH SÃCH</button>
    <button id="resetButton">ğŸ”„ PARTY Má»šI</button>
  `;
  
  content.innerHTML=reportHTML;
  popup.style.display="flex";
  
  document.getElementById("copyButton").addEventListener("click",copyDrunkList);
  document.getElementById("resetButton").addEventListener("click",resetGame);
}

function copyDrunkList(){
  let text="ğŸ‰ DANH SÃCH VAR SAY Xá»ˆN - TMA PARTY ğŸ»\n";
  text+="=".repeat(50)+"\n\n";
  
  caughtDrunks.forEach((item,idx)=>{
    text+=`${idx+1}. ğŸ­ ${item.name}\n`;
    text+=`   ğŸº ${item.reason}\n\n`;
  });
  
  text+="=".repeat(50)+"\n";
  text+=`ğŸ† Tá»•ng sá»‘ Var say xá»‰n: ${caughtDrunks.length}\n`;
  text+="ğŸŠ ChÃºc má»«ng cÃ¡c Var may máº¯n!";
  
  navigator.clipboard.writeText(text).then(()=>{
    const btn=document.getElementById("copyButton");
    const originalText=btn.innerText;
    btn.innerText="âœ“ ÄÃƒ COPY!";
    btn.style.background="linear-gradient(135deg,#00d2ff,#3a7bd5)";
    
    setTimeout(()=>{
      btn.innerText=originalText;
      btn.style.background="linear-gradient(135deg,#00d2ff,#3a7bd5)";
    },2000);
  }).catch(err=>{
    alert("KhÃ´ng thá»ƒ copy: "+err);
  });
}

function resetGame(){
  const popup=document.getElementById("popupOverlay");
  const popupDiv=document.getElementById("popup");
  popup.style.display="none";
  popupDiv.classList.remove('large');
  document.getElementById("ui").style.display="block";
  
  isGameRunning=false;
  isPaused=false;
  caughtDrunks=[];
  checkedDrunks=[];
  updateHUD();
}

function updateHUD(){
  const status=document.getElementById("status");
  const list=document.getElementById("caughtList");
  
  if(!isGameRunning){
    status.innerText="ğŸ‰ Sáºµn sÃ ng check Var!";
    list.innerHTML='';
    return;
  }
  
  status.innerHTML=`
    <strong>ğŸ¯ ÄÃ£ tÃ¬m:</strong> ${caughtDrunks.length}/${targetDrunks}<br>
    <span style="color:#667eea;font-size:13px;font-weight:600;">
      ${isPaused?'â¸ï¸ Äang check...':'ğŸ» Äang quÃ©t party...'}
    </span>
  `;
  
  if(caughtDrunks.length>0){
    let listHTML='<strong style="color:#ffa500;">ğŸ† Danh sÃ¡ch Ä‘Ã£ loáº¡i:</strong><br>';
    caughtDrunks.forEach((item,idx)=>{
      listHTML+=`
        <div class="drunk-item">
          ${idx+1}. <strong style="color:#ff6b6b;">${item.name}</strong>
        </div>
      `;
    });
    list.innerHTML=listHTML;
  }else{
    list.innerHTML='<em style="color:#9ca3af;">ChÆ°a cÃ³ Var nÃ o say xá»‰n...</em>';
  }
}

function updateChecker(){
  if(!isGameRunning || !checker || !checkerTarget || isPaused) return;
  
  const dx=checkerTarget.x-checkerPosition.x;
  const dz=checkerTarget.z-checkerPosition.z;
  const dist=Math.sqrt(dx*dx+dz*dz);
  
  if(dist>0.5){
    checkerPosition.x+=dx/dist*patrolSpeed;
    checkerPosition.z+=dz/dist*patrolSpeed;
    
    checker.position.x=checkerPosition.x;
    checker.position.z=checkerPosition.z;
    
    labels[labels.length-1].position.x=checkerPosition.x;
    labels[labels.length-1].position.z=checkerPosition.z;
    labels[labels.length-1].position.y=8;
    
    checker.rotation.y=Math.atan2(dx,dz);
  }else{
    checkerTarget=null;
    checkVar();
  }
}

function updateCamera(){
  if(isGameRunning){
    const panSpeed=0.5;
    
    const cameraDir=new THREE.Vector3();
    camera.getWorldDirection(cameraDir);
    cameraDir.y=0;
    cameraDir.normalize();
    
    const rightDir=new THREE.Vector3(-cameraDir.z,0,cameraDir.x);
    
    if(keys['w']||keys['W']){
      cameraTarget.x+=cameraDir.x*panSpeed;
      cameraTarget.z+=cameraDir.z*panSpeed;
    }
    if(keys['s']||keys['S']){
      cameraTarget.x-=cameraDir.x*panSpeed;
      cameraTarget.z-=cameraDir.z*panSpeed;
    }
    if(keys['a']||keys['A']){
      cameraTarget.x-=rightDir.x*panSpeed;
      cameraTarget.z-=rightDir.z*panSpeed;
    }
    if(keys['d']||keys['D']){
      cameraTarget.x+=rightDir.x*panSpeed;
      cameraTarget.z+=rightDir.z*panSpeed;
    }
  }
  
  camera.position.x=cameraTarget.x+cameraDistance*Math.sin(cameraAngleV)*Math.cos(cameraAngleH);
  camera.position.y=cameraTarget.y+cameraDistance*Math.cos(cameraAngleV);
  camera.position.z=cameraTarget.z+cameraDistance*Math.sin(cameraAngleV)*Math.sin(cameraAngleH);
  camera.lookAt(cameraTarget);
}

function animate(){
  requestAnimationFrame(animate);
  updateChecker();
  updateCamera();
  renderer.render(scene,camera);
}
animate();

/* ================= EVENT LISTENERS ================= */
document.getElementById("start").addEventListener("click",startGame);
document.getElementById("popupButton").addEventListener("click",continueCheck);

document.addEventListener("keydown",(e)=>{
  keys[e.key]=true;
});

document.addEventListener("keyup",(e)=>{
  keys[e.key]=false;
});

renderer.domElement.addEventListener("mousedown",(e)=>{
  isDragging=true;
  lastMouseX=e.clientX;
  lastMouseY=e.clientY;
});

document.addEventListener("mouseup",()=>{
  isDragging=false;
});

document.addEventListener("mousemove",(e)=>{
  if(!isDragging)return;
  
  const deltaX=e.clientX-lastMouseX;
  const deltaY=e.clientY-lastMouseY;
  
  cameraAngleH-=deltaX*0.01;
  cameraAngleV=Math.max(0.1,Math.min(Math.PI/2-0.1,cameraAngleV+deltaY*0.01));
  
  lastMouseX=e.clientX;
  lastMouseY=e.clientY;
});

renderer.domElement.addEventListener("wheel",(e)=>{
  e.preventDefault();
  cameraDistance+=e.deltaY*0.02;
  cameraDistance=Math.max(10,Math.min(80,cameraDistance));
});

window.addEventListener("resize",()=>{
  camera.aspect=innerWidth/innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth,innerHeight);
});

console.log("ğŸ» Check Var Say Xá»‰n ready! Party thÃ´i! ğŸ‰");
</script>
</body>
</html>
